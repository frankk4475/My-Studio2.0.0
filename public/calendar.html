<!DOCTYPE html>
<html lang='th'>
<head>
    <meta charset='utf-8' />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ปฏิทินงานสตูดิโอ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
</head>
<body class="bg-light">

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>ปฏิทินงาน</h1>
            <div>
                <a href="/index.html" class="btn btn-secondary">&larr; จัดการการจอง</a>
                <a href="/quotes.html" class="btn btn-info">จัดการใบเสนอราคา</a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div id='calendar'></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="event-detail-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="event-modal-title"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="event-modal-body">
            </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            
            // **(แก้ไข) เพิ่มการสร้าง instance ของ Modal ที่นี่**
            const eventDetailModalEl = document.getElementById('event-detail-modal');
            const eventDetailModal = new bootstrap.Modal(eventDetailModalEl);

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                
                // ส่วนนี้จะทำงานได้แล้วเพราะ eventDetailModal ถูกสร้างแล้ว
                eventClick: function(info) {
                    info.jsEvent.preventDefault();

                    const title = info.event.title;
                    const startDate = info.event.start.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                    const details = info.event.extendedProps.details || 'ไม่มีรายละเอียด';
                    const status = info.event.extendedProps.status;

                    document.getElementById('event-modal-title').innerText = title;
                    document.getElementById('event-modal-body').innerHTML = `
                        <p><strong>วันที่:</strong> ${startDate}</p>
                        <p><strong>สถานะ:</strong> ${status}</p>
                        <hr>
                        <p><strong>รายละเอียดงาน:</strong></p>
                        <p>${details}</p>
                    `;

                    eventDetailModal.show(); // เรียกใช้ Modal
                },

                events: function(fetchInfo, successCallback, failureCallback) {
                    fetch('/api/bookings', { headers: getAuthHeaders() })
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => successCallback(data))
                        .catch(error => {
                            failureCallback(error);
                            window.location.href = '/login.html';
                        });
                },
                
                eventDataTransform: function(bookingData) {
                    let eventColor = '#3788d8'; // Pending
                    if (bookingData.status === 'Confirmed') {
                        eventColor = '#198754'; // Green
                    } else if (bookingData.status === 'Cancelled') {
                        eventColor = '#dc3545'; // Red
                    }
                    return {
                        id: bookingData._id,
                        title: bookingData.customer,
                        start: bookingData.date,
                        details: bookingData.details, // **(แก้ไข)** เพิ่ม details เข้าไป
                        status: bookingData.status,   // **(แก้ไข)** เพิ่ม status เข้าไป
                        backgroundColor: eventColor,
                        borderColor: eventColor
                    };
                }
            });

            calendar.render();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>